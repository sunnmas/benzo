1 Справочники
a.«АЗС» – реквизиты: Наименование, НомерАЗС-число. Табличная часть Емкости:
Номенклатура, Объем.
b.«Номенклатура» - реквизиты: Наименование, Внешний код – число.
c.«КонтрагентыОбщие» - реквизиты: Наименование, НаименованиеПолное, ИНН,
КПП, почта, телефон.
d.КонтрагентыАЗС – реквизиты: Наименование, АЗС, ГолонойКонтрагент – тип
КонтрагентыОбщие



e.Карты – реквизиты: номер, КонтрагентОбщие, ТипКарты – перечисление
Дисконтная или Топливная, Состояние – ВРаботе/Заблокирована/НеВыдана

    Файл CARD_2_.....
    ----------------------------------
    300;00000001777555544073;;;True;False;False;False;;;;сЕРОВ а.в. 4407 89376760484
    3000;00000001555777700633;23;;True;False;False;False;;;;0053 Г.№ Е152ТР
    300;00000001777555544080;;;True;False;False;False;;;;пАРШЕНКОВ в.и. 4408 89879955315

    1   DistCode        I       Код эмитента карт. (Обязательно !!! и не должно быть равно 0)
    2   Code            A   20  Номер катры (Обязательно !!! и не должно быть равно ‘’)
    3   ClientCode      I       Код клиента. (не должно быть равно 0)
    4   ToDate          D       Дата окончания срока действия карты
    5   Enabled         L       Признак «карта разрешена/запрещена»
    6   UseDate         L       Признак – проверять ли срок действия карты по полю ToDate (True – проверять, False – не проверять)
    7   CheckBalance    L       Служебное
    8   Debit           L       Признак «+/-»  (True – литраж и сумма вычитаются  из  общего баланса клиента,  False – прибавляются к балансу)
    9   AmntDayLimit    $       Суточный лимит на общую денежную сумму отпущенного топлива. (Если поле пустое или 0 – лимита нет)
    10  AmntMonthLimit  $       Месячный лимит на общую денежную сумму отпущенного топлива. (Если поле пустое или 0 – лимита нет)
    11  AmntTotalLimit  $       Лимит на общую денежную сумму (денежный баланс). (Если поле пустое или 0 – лимита нет)
    12  Note            A   50  Примечание


    !!Код клиента заполнен очень редко



f.Основания – наименование, внешнийкод, ВидОплаты – наличгые или
безналичные.

2 Документы
a.ОтчетОПродажах – реквизиты: Дата, АЗС, Оператор, СуммаНал, СуммаБезНал.
ТабЧасть: ЦеныНаАЗС считываются из РС. Еще ТабличнаяЧасть: время,
контрагентазс, контрагентОбщий, номерКарты, Номенклатура, количество(литров),
сумма, основание, видоплаты.


b.УстановкаЦен – Дата,ДатаПрименения, АЗС. ТабЧасть: Номенклатура, Цена.
Необходимо формировать документом установка цен и файл PRICE
№   Название поля   Тип Размер  Описание
1   Num             I           Код топлива
2   Marka           A   10      Название топлива
3   Price           $           Цена топлива
4   NextPrice       $           Отложенная цена на топливо
5   PriceChDate     D           Дата установки отложенной цены на топливо





c.ПополнениеСписание – Дата, ТабЧасть: КонтрагентОбщий, КонтрагентАЗС, Сумма,
БлокировкаРазблокировка - булево.

3 РегистрыСведений
a. ЦеныНаАЗС – АЗС, номенклатура, цена. Периодический.
4 РегистрыНакопления
a.ВзаиморасчетыСКонтрагентами – КонтрагентОбщий, Приход/Расход, Сумма
b.Продажи – АЗС, Основание, КонтрагентОбщий, Сумма.

1
«КонтрагентыОбщие» - при записи нового контрагента создаются такие же контрагенты
для всех АЗС в справочнике КонтрагентыАЗС.
2
Обработка «Отправка отчетов». Обработка перебирает всех контрагентов и если у них
занесена в базу почта формирует 2 отчета: Отчет по обслуживаниям и Состояние баланса и
отправляет им на почту.
3
Обработка «Загрузка и выгрузка данных». Две кнопки: Загрузка – загружает данные со
всех АЗС. Выгрузка: выгружает все данные на АЗС. Загрузка и выгрузка делается: по
требованию и автоматически каждый час.



* Справочник АЗС формируем вручную

* Справочник КонтрагентыОбщие формируем вручную

* Справочник КонтрагентыАЗС грузим из файла CLNT
    - Предотвращена повторная загрузка контрагентаАзс из файла, если в базе уже есть запись с таким внешним кодом и данной АЗС 
    - Если на соседней АЗС есть контрагент с данным внешним кодом, то появится элемент с дубляжом внешнего кода, но уникальный по номеру АЗС
    - Если на соседней АЗС есть контрагент с данным наименованием, то появится элемент с дубляжом наименования, но с уникальной парой: внешнийКод и АЗС
    !- Если в наливной программе меняется наименование контрагента, то в базе изменение фиксируется
    - Если в наливной программе изменился код контрагента - получим дубль контрагента в базе
    - Т.к. справочник заполняется автоматически - запрещаем править все реквизиты кроме головного контрагента, для предотвращения нарушения целостности
    - Запрет создания новых КонтрагентовАЗС вручную
    - Запрет удаления КонтрагентовАЗС вручную


* Справочник Карты грузим из файла CARD
    - 300 - Дисконтная
    - 3000 - Топливная
    - Enabled = True - ВРаботе
    - Enabled = False - Заблокирована
    - НеВыдана только для топливной карты, если не назначен код клиента
    - Запрет редактирования всех полей кроме КонтрагентОбщий и Состояние
    - При записи карты с выбранным КонтрагентОбщий автоматически проставляется реквизит ГоловнойКонтрагент для всех
        КонтрагентовАЗС, привязанных к карте
    - При создании дисконтной карты реквизиту КонтрагентОбщий назначается предопределенный элемент справочника РозничныйПокупатель
    - При попытке сменить у дисконтной карты КонтрагентОбщий с РозничногоПокупателя на какой либо другой приводит к отказу записи с выводом сообщения об ошибке
    - Запрет создания новых карт вручную
    - Запрет удаления крат вручную





SALE

OPERATORAZS;                OPERATORAZS;                    1   Host        A   16  Название компьютера (имеет смысл для многопользовательской версии)
27.12.2020 10:38:33;        27.12.2020 10:19:45;            2   DateTime    @       Дата и время продажи
2;                          7;                              3   NumTRK      S       № ТРК
52;                         0; !!!!!!!!!!!!!!!!!!!!!        4   ClientCode  I       Код клиента
00000001555777702408;       00000001777555519880;           5   CardCode    A   20  Номер карты
3000;                       300;                            6   DistCode    I       Код эмитента карт
22;                         92;                             7   Product     S       Код вида топлива
200;                        11,9;                           8   LitPresel   N       Заказ (в литрах)
200;                        500;                            9   CurPresel   $       Заказ (в деньгах)
1;                          40,74;                          10  Price       $       Цена, по которой отпущено топливо
38,61;                      11,91;                          11  LitFact     N       Фактически отпущенное количество литров топлива
38,61;                      485,21;                         12  CurFact     $       Фактическая сумма (на которую отпущено топливо)
1;                          0;                              13  PaymentKind I       Тип платежа: 0 – Нал. / 1 – Безнал.
8;                          7;                              14  Osnovanye   I       Основание, на котором происходила продажа (Скидка, тех. Пролив и т.д.)
5;                          4;                              15  NumTank     S       № емкости, из которой происходил налив
1;                          1;                              16  NumNozz     S       № пистолета, с которого происходил налив
;                           ;                               17  CancelCh    S       Признак того, что печать чека была отменена оператором или для операций с картами - был возврат без предъявления карты
                                                                            Коды:
                                                                             1 – чек по факту
                                                                             2 – чек по заказу
                                                                             3 – чек возврата
                                                                             4 – чек аннулирования
                                                                            13 – возврат без предъявления карты

;                ;                               18  Note        A   50  Примечание
;                ;                               19  Density     N       Текущая плотность в резервуаре (с вер 2.20)
;                ;                               20  Temperature N       Текущая температура в резервуаре (с вер 2.20)
24,1;                42;                             21  BasePrice   $       Базовая цена топлива
False                True                            22  PP          L       Признак (предоплата — False / постоплата - True)






Шаги до начала работы в 1С:
- Подготовить инфу обо всех корпоративных контрагентах ИНН, телефон, почта, 
- На заправках убрать внутриазсные дубли карт (либо править файлы выгрузок карт напрямую)
- Привести список Оснований к одному виду будучи в полной уверенности, что их перетасовка не повредит АЗС
- Настроить выгрузку данных по 4 раза в день на всех АЗС
- Одинаково поименовать папки выгрузки и загрузки на всех АЗС
- Остановить любую правку карт на заправках. Начиная с этого момента нужно чтобы данные не изменялись (карты не добавлялись/ не удалялись и т.д., то же самое с контрагентами)
- Делаем выгрузку со всех АЗС на яндекс диск

Шаги для начала работы в 1С
- С этого момента пока нельзя не добавлять в 1С Карты, контрагентыОбщие и КонтрагентыАЗС вручную, когда станет можно - см.ниже
- Зайти под администратором
- Выполнить однократно обработку ОчисткаБазы
- Настроить константу "Путь файлам к данных АЗС"
- Настроить константу "Логин от почты" (работает только с яндексом)
- Настроить константу "Пароль от почты"
- Обязательно убедиться, что константа "СоздаватьНедостающихКонтрагентовАЗСПриМодификацииКонтрагентаОбщего" = Ложь
- На сайте яндекса войти в свой аккаунт почты и настроить на закладке 
    Почта → Все настройки → Почтовые программы 
    Поставить первую и третью галки поп, имап
- в справочнике азс заполнить коды дистрибьюторов 300/3000, 1/2
- Сделать бекап базы 1С. В бекапе чистая база настроенная база
- Выполнить однократно обработку Загрузка Контрагентов и Карт. Если встретятся ошибки, например, есть дубли карт на заправках, то откатываемся на чистую базу 1С, исправляем ошибки в файлах карт и контрагентов, пробуем загружать контрагентов и карты заново. Повторяем данный шаг до тех пор, пока не прогрузятся данные без ошибок
- Выполнить переименование всех КонтрагентовОбщих одним стилем, например ООО "Рога и Копыта".
    Этим шагом мы добиваемся наглядности дублей в справочнике КонтрагентыОбщие, например:
        птицефабрика Атемарская
        Атемарская пт-фка - такие контрагенты будут порознь в списке контрагентов

        станут

        ООО "Атемарская птицефабрика"
        ООО "Атемарская птицефабрика" - такие контрагенты будут стоять рядом при сортировке по наименованию
                                        дубли легко заметить и в дальнейшем объединить
    !!!!Переименование КонтрагентаОбщего приводит к переименованию КонтрагентаАЗС, поэтому:
    !Прежде чем переименовать КонтрагентаОбщего нужно открыть список всех его карт и убедиться в корректности !КонтрагентовАЗС. Обязательно будут случаи, когда:
    !
    !КонтрагентОбщий=Пегас
    !    Карта=000ххххххх
    !        КонтрагентыАЗС:
    !            Пегас Чамзинка
    !            Пегас Шайгово
    !            МагмаХД Ардатов
    !Увидев такое, необходимо принять решение переименовывать КонтрагентОбщий в Пегас или в МагмаХД
    !После переименования КонтрагентаОбщего наименования всех КонтрагентовАЗС будут одинаковыми для всех АЗС по данной карте
- Заполняем ИННы всех КонтрагентовОбщих, для перестраховки. Далее при объединении контрагентов можно будет объединять только контрагентов с одинаковым ИНН
- Сделать бекап базы 1С, в бекапе настроенная база, прогруженные карты, контрагенты общие поименованы в едином стиле, заполнены ИННы
- Выполнить многократно обработку объединение контрагентов общих
    Данная обработка удаляет лишние контрагенты общие, оставляя только один из указанных, перекидывая карты и контрагенты азс на 
    одного контрагента общего
    Выполнять данную процедуру, контролируя правильность объединения вручную (выписать все айдишники карт, контрагентовАЗС и контрагентовОбщих до объединения, после объединения контролировать).
    Если объедиенеие зафейлилось либо устраняем проблему вручную, либо окатываемся к бекапу и все заново объединяем, добиваясь тотального объединения дублей контрагентов общих.
- Выполнить обработку Контроль Целостности Базы. Убедиться, что отсутсвуют контрагенты общие с отсутствующим и повторяющимся ИНН, если таковые имеются, то вернуться к предыдущему шагу
- Сделать бекап базы 1С. в бекапе настроенная база, прогруженные карты, контрагенты и контрагенты поименованы в едином стиле и отсутствуют дубли контрагентов общих, ИНН все заполнены и не повторяются
- Выполнить однократно обработку заполнить недостающие контрагенты азс
    Данная обработка создает для каждой карты по одному контрагенту азс для каждой из азс, генерируя уникальные внешние коды для
    вновь созданных контрагентов азс. В результате для каждого контрагента общего будет существовать столько контрагентов азс
    сколько азс присутствует в базе. Для избежания существования лишних контрагентов азс на предыдущем шаге необходимо выполнить 
    тотальное объединение контрагентов общих, убрав все повторяющиеся контрагенты общие.
- Запустить обработку Контроль целостности базы. Посмотреть на проблемы - принять решение что с ними делать. Оставить проблемы без рассмотрения или исправить все вручную. После исправлений вновь запускаем Контроль целостности данных, повторяем до тех пор, пока не добъемся приемлемых результатов. Обнаружатся контрагенты азс без карт, без контрагентов общих - таких контрагентов на данном этапе можно удалять (раньше нельзя было удалять т.к. при создании недостающих контрагентов АЗС генерация уникальных айдишников для АЗС может зависеть от нумерации таких вот непривязанных ни к чему контрагентов АЗС)
- Сделать бекап базы 1С. На данном этапе должны иметь базу с полными целостными данными со всех АЗС
- Зайти под управляющим
- Установить цены на всех АЗС с помощью документа Установка Цен
        Если готовимся загружать данные, например с начала 2021 г и за этот период цены на АЗС изменялись,
        то воссоздать историю изменения цен за данный период
- Ввести начальные остатки на балансах пользователей на начало загружаемого периода (Документ Пополнения/Списания)
- Воссоздать историю пополнений и списаний и блокировок для контрагентов с начала периода
- Заполнить данные контрагентов общие (почта, телефон, инн, скидка, лимит)
- Сделать бекап базы 1С. Имеем базу, готовую к загрузкам данных с корректными данными включая цены на топливо, информацию о пополнениях и списаниях пользователей, их лимитах и скидках
- Загрузку и выгрузку отдельных АЗС можно отключить установкой пометки удаления на соответствующую АЗС
- Выполнить загрузку данных продаж с АЗС
- Проконтролировать балансы пользователей с помощью отчета Отчет по обслуживаниям
- Попробовать разослать отчеты контрагентам выборочно и проконтролировать их доставку. Кнопка Уведомить в справочнике Контрагенты Общие
- Установить константу "СоздаватьНедостающихКонтрагентовАЗСПриМодификацииКонтрагентаОбщего" = Истина под администратором
- Если все работает корректно - выполнить бекап 1С. Если не корректно - действуем по обстоятельствам
- Начиная с этого момента уже можно вручную добавлять карты и контрагентыОбщие. КонтрагентыАЗС не добавлять - они будут создаваться при создании КонтрагентаОбщего.
- Сделать бекап базы наливной программы на одной АЗС
- Попробовать выполнить выгрузку данных на эту заправку и проконтролировать правильность загрузки на АЗС
- Проделать выгрузку данных на остальные АЗС по одной, контролируя, что получается
- Работать, но первое время смотреть все внимательно, сверять все и пересчитывать за программой, записывать все глюки на листочек с подробным описанием и текстом ошибок, возможно фото на телефон, делать бекапы базы перед каждым серьезным изменением
- Обратить внимание на недостающие права роли Управляющего. Подготовить список недостающих прав, я их предоставлю


Выгрузка справочника Оснований
Автоматическая выгрузка справочников на АЗС
Выгрузка прайс листа

КонтрольЦелостности
    - Каждому КонтрагентуАЗС назначена АЗС
    - Каждому КонтрагентуАЗС назначен КонтрагентОбщий
    - Количество КонтрагентовАЗС-1 кратно количеству заправок
    - Каждой карте назначен КонтрагентОбщий
    - Каждой карте назначено столько контрагентов АЗС, сколько заправок существуеты
    - Количество КонтрагентовОбщих-1 меньше в количество заправок чем количество КонтрагентовАЗС-1


sp.oil13
Sarnsk2018


Создание недостающих КонтрагентовАЗС при загрузке контрагентов и карт
Разблокировка карт при пополнении
Блокировка карт при проведении Пополнения/Списания
Блокировка карт при получении данных о продажах до проведения


Надо
Список АЗС с настоящими номерами
АЗС 2
3000;00000001555777701562;23;;True;False;False;False;;;;0157 (23;МАГМА ХД;False;False;;;;)
АЗС5 основание 15, 14
АЗС5 отсутствуют клиенты 13,14,15
АЗС4 основание 100
АЗС3 основание 70


Для карты 00000001777555525836 на каких-то заправках назначено разное состояние (3 и 6)
Для карты 00000001555777700114 на каких-то заправках вычисляется различный Контрагент Общий (3 и 6)
    на азс 3 контрагент = 6 Фармация
    на азс 6 контрагент = 10 Фармация



Примечаниями нельзя управлять с азс
Разбиение продаж по дням
Виды блокировок
    Если хоть одна установлена - карта на АЗС заблокирована



    2. однородности в справочнике КонтрагентыАЗС
        Все контрагенты АЗС
            птицефабрика Атемарская | Комсомольский
            Атемарская пт-фка       | Огни Саранска
        станут
            ООО "Атемарская птицефабрика" | Комсомольский
            ООО "Атемарская птицефабрика" | Огни Саранска

!!!!!!!!!!!!!!!
Внимание на данном шаге переименовываются контрагентыАЗС, связанные с контрагентомОбщим
    В базе есть такие данные:
     Бацунов С.В. (общий)
        Бацунов С.В. (АЗС)
        ГАЗПРОМ (АЗС)
И Я ХУЙ Его знает че с этим делать
!!!!!!!!!!!!!!!